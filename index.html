<html>
  <head>
    <title>Feat-Tac-Toe</title>
    <style>
      * {
        margin: 0;
        font-size: 100%;
        font-family: sans-serif;
        font-weight: lighter;
      }
      body {
        background-color: #fffffb;
        height: 100vh;
      }
      h1 {
        font-size: 2.5em;
        font-family: "Times New Roman", serif;
        margin: 0 0 0.5em;
        color: #822000;
        font-variant: small-caps;
      }
      #toggle-info {
        position: absolute;
        background: transparent;
        top: 0;
        right: 0.5em;
        opacity: 0.3;
        cursor: pointer;
        border: none;
        font-size: 0.75em;
        line-height: 1.5em;
      }
      #content {
        margin: auto;
        display: flex;
        flex-direction: column;
        justify-content: center;
        height: 100%;
      }
      #container {
        max-width: 33em;
        width: 100%;
        margin: 0 auto;
        padding: 0 0.75em;
        position: relative;
      }
      #grid {
        aspect-ratio: 1 / 1;
        background-color: #fefdee;
        position: relative;
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        grid-template-rows: 1fr 1fr 1fr;
        column-gap: 1em;
        row-gap: 1em;
        box-shadow: 0px 2px 4px grey;
      }
      .challenge {
        margin: auto auto;
        text-align: center;
        align-self: center;
        cursor: pointer;
        position: relative;
      }
      .challenge.false::after {
        content: "✓";
        font-size: 7em;
        opacity: 0%;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: grey;
        text-shadow: 3px 3px 3px black;
        transition: opacity 0.2s;
      }
      .challenge.false:hover::after {
        opacity: 20%;
        transition: opacity 0.2s;
      }
      .challenge.true {
        opacity: 50%;
      }
      .challenge.true::after {
        content: "✓";
        font-size: 7em;
        opacity: 100%;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: green;
        text-shadow: 3px 3px 3px black;
      }
      #info {
        height: 100%;
        grid-column: 1 / span 3;
        grid-row: 1 / span 3;
      }
      #info p,
      #info li {
        margin: 0 0 1em;
      }
      .bordered {
        padding: 1em;
        border: 0.1em beige solid;
        border-radius: 1em;
      }
      #menu {
        content: "☰";
        font-size: 1.5em;
        position: absolute;
        top: 0.5em;
        left: 0.5em;
        background: none;
        border: none;
        cursor: pointer;
      }
      #overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.2);
        z-index: 10;
        display: none;
        transition: display 0.2s;
      }
      #overlay.visible {
        display: unset;
        transition: display 0.4s;
      }
      #sidebar {
        padding: 1em 1em 0;
        width: 15em;
        height: calc(100% - 1em);
        position: absolute;
        top: 0;
        transform: translate(-100%, 0);
        transition: transform 0.2s;
        background-color: #fffffb;
        z-index: 99;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        box-shadow: 0px 1px 4px grey;
      }
      #sidebar.visible {
        transform: translate(0%, 0%);
        transition: transform 0.4s;
      }
      #sidebar a {
        display: block;
        text-decoration: none;
        margin: 0 0 1em;
      }
      #legal {
        color: #aaaaaa;
        text-align: center;
        font-size: 0.8em;
        padding-bottom: 1em;
      }
      #legal div {
        margin: 0 0 0.5em;
      }
    </style>
    <script>
      const defaults = {
        "#feat-lucky": {
          featId: "#feat-lucky",
          featName: "Lucky",
          featDescription: {
            p: [
              "You have inexplicable luck that seems to kick in at just the right moment.",
              "You have 3 luck points. Whenever you make an attack roll, an ability check, or a saving throw, you can spend one luck point to roll an additional d20. You can choose to spend one of your luck points after you roll the die, but before the outcome is determined. You choose which of the d20s is used for the attack roll, ability check, or saving throw.",
              "You can also spend one luck point when an attack roll is made against you. Roll a d20, and then choose whether the attack uses the attacker's roll or yours. If more than one creature spends a luck point to influence the outcome of a roll, the points cancel each other out; no additional dice are rolled.",
              "You regain your expended luck points when you finish a long rest.",
            ],
          },
          challenges: [
            { status: false, description: "Roll a nat 20 on a Strength check or saving throw" },
            { status: false, description: "Roll a nat 20 on an attack" },
            { status: false, description: "Roll a nat 20 on a Intellect check or saving throw" },
            { status: false, description: "Roll a nat 20 on a Dexterity check or saving throw" },
            { status: false, description: "Roll a nat 1 on any check or saving throw" },
            { status: false, description: "Roll a nat 20 on a Wisdom check or saving throw" },
            { status: false, description: "Roll a nat 20 on a Constitution check or saving throw" },
            { status: false, description: "Survive a critical hit without being knocked unconscious" },
            { status: false, description: "Roll a nat 20 on a Charisma check or saving throw" },
          ],
        },
        "#feat-great-weapon-master": {
          featId: "#feat-great-weapon-master",
          featName: "Great Weapon Master",
          featDescription: {
            p: [
              "You've learned to put the weight of a weapon to your advantage, letting its momentum empower your strikes. You gain the following benefits:",
            ],
            ul: [
              "On your turn, when you score a critical hit with a melee weapon or reduce a creature to 0 hit points with one, you can make one melee weapon attack as a bonus action.",
              "Before you make a melee attack with a heavy weapon that you are proficient with, you can choose to take a -5 penalty to the attack roll. If the attack hits, you add +10 to the attack's damage.",
            ],
          },
          challenges: [
            { status: false, description: "Roll a nat 20 on an attack roll with a 2-handed weapon" },
            { status: false, description: "Defeat an enemy with a greataxe" },
            { status: false, description: "Deal max damage with a 2-handed weapon" },
            { status: false, description: "Defeat an enemy with a greatsword" },
            { status: false, description: "Own at least four 2-handed weapons" },
            { status: false, description: "Defeat an enemy with a maul or greatclub" },
            { status: false, description: "Defeat 2 or more enemies in a single turn with a 2-handed weapon" },
            { status: false, description: "Defeat an enemy with a halberd" },
            { status: false, description: "Roll a nat 20 on a Strength check or saving throw" },
          ],
        },
        "#feat-mobile": {
          featId: "#feat-mobile",
          featName: "Mobile",
          featDescription: {
            p: ["You are exceptionally speedy and agile. You gain the following benefits:"],
            ul: [
              "Your speed increases by 10 feet.",
              "When you use the Dash action, difficult terrain doesn't cost you extra movement on that turn.",
              "When you make a melee attack against a creature, you don't provoke opportunity attacks from that creature for the rest of the turn, whether you hit or not.",
            ],
          },
          challenges: [
            { status: false, description: "Roll a nat 20 for a Dexterity check or saving throw" },
            {
              status: false,
              description: "Use your entire movement and move through at least 5 feet of difficult terrain",
            },
            { status: false, description: "Successfully jump 10 feet or more over an obstacle during combat" },
            { status: false, description: "Use your entire movement and successfully attack an enemy" },
            { status: false, description: "Take the Dash action in 5 separate combats" },
            { status: false, description: "Take the dodge action and successfully avoid incoming damage" },
            { status: false, description: "Successfully climb 15 feet or more during combat" },
            {
              status: false,
              description: "Take the disengage action to avoid opportunity attacks from 3 enemies in a single turn",
            },
            { status: false, description: "Use your entire movement after taking the Dash action" },
          ],
        },
        "#feat-war-caster": {
          featId: "#feat-war-caster",
          featName: "War Caster",
          featDescription: {
            p: [
              "You have practiced casting spells in the midst of combat, learning techniques that grant you the following benefits:",
            ],
            ul: [
              "You have advantage on Constitution saving throws that you make to maintain your concentration on a spell when you take damage.",
              "You can perform the somatic components of spells even when you have weapons or a shield in one or both hands.",
              "When a hostile creature's movement provokes an opportunity attack from you, you can use your reaction to cast a spell at the creature, rather than making an opportunity attack. The spell must have a casting time of 1 action and must target only that creature.",
            ],
          },
          challenges: [
            { status: false, description: "Succeed on a constitution check to maintain concentration while casting" },
            { status: false, description: "Kill an enemy with a spell at a distance of 60 feet or more" },
            {
              status: false,
              description:
                "Move at least 15 feet and cast a spell with a range of Touch during a single turn of combat",
            },
            { status: false, description: "Avoid or otherwise prevent damage by casting a spell with your reaction" },
            { status: false, description: "Roll a nat 20 on an spell attack roll" },
            {
              status: false,
              description:
                "In a single combat, cast 3 or more spells using a spell slot greater than that spell’s level",
            },
            { status: false, description: "Kill an enemy with a spell at a distance of 30 feet or less" },
            { status: false, description: "Damage 3 or more enemies with a single spell" },
            { status: false, description: "Successfully use your reaction to hit an enemy with an opportunity attack" },
          ],
        },
      };

      function challengeNode(feat, idx) {
        const challenge = feat.challenges[idx];
        const node = document.createElement("div");
        node.id = idx;
        node.className = `challenge ${challenge.status}`;
        node.innerText = challenge.description;
        node.onclick = function (evt) {
          toggleAchievement(feat.featId, idx);
        };
        return node;
      }

      function toggleAchievement(featId, challengeIdx) {
        const state = getState();
        const feat = state[featId];
        feat.challenges[challengeIdx].status = !feat.challenges[challengeIdx].status;
        saveState(state);
        if (checkComplete(feat)) {
          renderInfo(feat);
        } else {
          const challenge = document.getElementById(challengeIdx);
          challenge.replaceWith(challengeNode(feat, challengeIdx));
        }
      }

      function renderChallenges(feat) {
        const children = [];
        for (let i = 0; i < feat.challenges.length; i += 1) {
          const child = challengeNode(feat, i);
          children.push(child);
        }
        document.getElementById("grid").replaceChildren(...children);
      }

      function renderInfo(feat) {
        const featInfo = document.createElement("div");
        featInfo.id = "info";
        const children = [];
        for (const entry of feat.featDescription.p) {
          const p = document.createElement("p");
          p.innerText = entry;
          children.push(p);
        }
        if (feat.featDescription.ul && feat.featDescription.ul.length) {
          const ul = document.createElement("ul");
          for (const entry of feat.featDescription.ul) {
            const li = document.createElement("li");
            li.innerText = entry;
            ul.appendChild(li);
          }
          children.push(ul);
        }
        featInfo.replaceChildren(...children);
        document.getElementById("grid").replaceChildren(featInfo);
      }

      function toggleInfo(feat) {
        if (document.getElementById("grid").childNodes.length > 1) {
          renderInfo(feat);
        } else {
          renderChallenges(feat);
        }
      }

      function checkComplete(feat) {
        // Define winning combinations as indices in the gameState array
        const winCombinations = [
          [0, 1, 2],
          [3, 4, 5],
          [6, 7, 8], // Rows
          [0, 3, 6],
          [1, 4, 7],
          [2, 5, 8], // Columns
          [0, 4, 8],
          [2, 4, 6], // Diagonals
        ];

        const challenges = feat.challenges;
        let complete = false;
        // Check each winning combination
        for (let combination of winCombinations) {
          const [a, b, c] = combination;
          if (challenges[a].status && challenges[b].status && challenges[c].status) {
            return true; // 3-in-a-row found
          }
        }
        return false;
      }

      function populateMenu(state) {
        const children = [];
        for (const featId of Object.keys(state)) {
          const feat = state[featId];
          const child = document.createElement("a");
          child.id = `a-${feat.featName}`;
          child.href = `${featId}`;
          child.innerText = feat.featName;
          child.onclick = function () {
            setTimeout(renderState, 10);
            toggleSidebar();
          };
          children.push(child);
        }
        document.getElementById("nav-links").replaceChildren(...children);
      }

      function getState() {
        const state = localStorage.getItem("feat-tac-toe");
        if (!state) {
          saveState(defaults);
          return JSON.parse(defaults);
        }
        return JSON.parse(state);
      }

      function saveState(state) {
        localStorage.setItem("feat-tac-toe", JSON.stringify(state));
      }

      function renderState() {
        const state = getState();
        const featId = window.location.hash || "#feat-lucky";
        const feat = state[featId];
        const container = document.getElementById("container");
        const header = document.createElement("h1");
        header.innerText = feat.featName;
        const toggleButton = document.createElement("button");
        toggleButton.id = "toggle-info";
        toggleButton.innerText = "ⓘ";
        toggleButton.onclick = function () {
          const feat = getState()[featId];
          toggleInfo(feat);
        };
        header.append(toggleButton);
        const grid = document.createElement("div");
        grid.id = "grid";
        grid.className = "bordered";
        container.replaceChildren(header, grid);
        if (checkComplete(feat)) {
          renderInfo(feat);
        } else {
          renderChallenges(feat);
        }

        populateMenu(state);
      }

      function toggleSidebar() {
        document.getElementById("sidebar").classList.toggle("visible");
        document.getElementById("overlay").classList.toggle("visible");
      }

      window.onload = renderState;
    </script>
  </head>
  <body>
    <button id="menu" onclick="toggleSidebar()">☰</button>
    <div id="overlay" onclick="toggleSidebar()"></div>
    <div id="sidebar">
      <div id="nav-links"></div>
      <div id="legal">
        <div>Dungeons & Dragons content is property of Wizards of the Coast LLC.</div>
        <div>Original content &copy;2023, Patrick Stewart</div>
      </div>
    </div>
    <div id="content">
      <nav id="nav"></nav>
      <div id="container"></div>
    </div>
  </body>
</html>
